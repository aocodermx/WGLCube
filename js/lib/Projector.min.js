THREE.RenderableObject=function(){this.id=0;this.object=null;this.renderOrder=this.z=0};
THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.normalModel=new THREE.Vector3;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsLength=0;this.color=new THREE.Color;this.material=null;this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2];this.renderOrder=this.z=0};
THREE.RenderableVertex=function(){this.position=new THREE.Vector3;this.positionWorld=new THREE.Vector3;this.positionScreen=new THREE.Vector4;this.visible=!0};THREE.RenderableVertex.prototype.copy=function(F){this.positionWorld.copy(F.positionWorld);this.positionScreen.copy(F.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.vertexColors=[new THREE.Color,new THREE.Color];this.material=null;this.renderOrder=this.z=0};
THREE.RenderableSprite=function(){this.id=0;this.object=null;this.rotation=this.z=this.y=this.x=0;this.scale=new THREE.Vector2;this.material=null;this.renderOrder=0};
THREE.Projector=function(){function F(){if(K===L){var b=new THREE.RenderableVertex;x.push(b);L++;K++;return b}return x[K++]}function X(){if(P===Y){var b=new THREE.RenderableFace;Z.push(b);Y++;P++;return b}return Z[P++]}function aa(){if(Q===ba){var b=new THREE.RenderableLine;ca.push(b);ba++;Q++;return b}return ca[Q++]}function ja(){if(R===da){var b=new THREE.RenderableSprite;ea.push(b);da++;R++;return b}return ea[R++]}function fa(b,l){return b.renderOrder!==l.renderOrder?b.renderOrder-l.renderOrder:
b.z!==l.z?l.z-b.z:b.id!==l.id?b.id-l.id:0}function ka(b,l){var f=0,h=1,m=b.z+b.w,e=l.z+l.w,g=-b.z+b.w,k=-l.z+l.w;if(0<=m&&0<=e&&0<=g&&0<=k)return!0;if(0>m&&0>e||0>g&&0>k)return!1;0>m?f=Math.max(f,m/(m-e)):0>e&&(h=Math.min(h,m/(m-e)));0>g?f=Math.max(f,g/(g-k)):0>k&&(h=Math.min(h,g/(g-k)));if(h<f)return!1;b.lerp(l,f);l.lerp(b,1-h);return!0}var C,S,ga=[],ha=0,M,K,x=[],L=0,f,P,Z=[],Y=0,h,Q,ca=[],ba=0,q,R,ea=[],da=0,m={objects:[],lights:[],elements:[]},r=new THREE.Vector3,n=new THREE.Vector4,la=new THREE.Box3(new THREE.Vector3(-1,
-1,-1),new THREE.Vector3(1,1,1)),ma=new THREE.Box3,B=Array(3),ia=new THREE.Matrix4,G=new THREE.Matrix4,D,T=new THREE.Matrix4,U=new THREE.Matrix3,V=new THREE.Frustum,H=new THREE.Vector4,I=new THREE.Vector4;this.projectVector=function(b,f){console.warn("THREE.Projector: .projectVector() is now vector.project().");b.project(f)};this.unprojectVector=function(b,f){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");b.unproject(f)};this.pickingRay=function(b,f){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};
var u=new function(){function b(c){var a=c.positionWorld,d=c.positionScreen;a.copy(c.position).applyMatrix4(D);d.copy(a).applyMatrix4(G);a=1/d.w;d.x*=a;d.y*=a;d.z*=a;c.visible=-1<=d.x&&1>=d.x&&-1<=d.y&&1>=d.y&&-1<=d.z&&1>=d.z}function l(c,a,d){if(!0===c.visible||!0===a.visible||!0===d.visible)return!0;B[0]=c.positionScreen;B[1]=a.positionScreen;B[2]=d.positionScreen;return la.intersectsBox(ma.setFromPoints(B))}function q(c,a,d){return 0>(d.positionScreen.x-c.positionScreen.x)*(a.positionScreen.y-
c.positionScreen.y)-(d.positionScreen.y-c.positionScreen.y)*(a.positionScreen.x-c.positionScreen.x)}var n=[],r=[],e=null,g=null,k=new THREE.Matrix3;return{setObject:function(c){e=c;g=e.material;k.getNormalMatrix(e.matrixWorld);n.length=0;r.length=0},projectVertex:b,checkTriangleVisibility:l,checkBackfaceCulling:q,pushVertex:function(c,a,d){M=F();M.position.set(c,a,d);b(M)},pushNormal:function(c,a,d){n.push(c,a,d)},pushUv:function(c,a){r.push(c,a)},pushLine:function(c,a){var d=x[c],b=x[a];h=aa();h.id=
e.id;h.v1.copy(d);h.v2.copy(b);h.z=(d.positionScreen.z+b.positionScreen.z)/2;h.renderOrder=e.renderOrder;h.material=e.material;m.elements.push(h)},pushTriangle:function(c,a,d){var b=x[c],h=x[a],p=x[d];if(!1!==l(b,h,p)&&(g.side===THREE.DoubleSide||!0===q(b,h,p))){f=X();f.id=e.id;f.v1.copy(b);f.v2.copy(h);f.v3.copy(p);f.z=(b.positionScreen.z+h.positionScreen.z+p.positionScreen.z)/3;f.renderOrder=e.renderOrder;f.normalModel.fromArray(n,3*c);f.normalModel.applyMatrix3(k).normalize();for(b=0;3>b;b++)h=
f.vertexNormalsModel[b],h.fromArray(n,3*arguments[b]),h.applyMatrix3(k).normalize(),f.uvs[b].fromArray(r,2*arguments[b]);f.vertexNormalsLength=3;f.material=e.material;m.elements.push(f)}}}};this.projectScene=function(b,l,B,M){function L(a){if(S===ha){var b=new THREE.RenderableObject;ga.push(b);ha++;S++;C=b}else C=ga[S++];C.id=a.id;C.object=a;r.setFromMatrixPosition(a.matrixWorld);r.applyProjection(G);C.z=r.z;C.renderOrder=a.renderOrder;m.objects.push(C)}R=Q=P=0;m.elements.length=0;!0===b.autoUpdate&&
b.updateMatrixWorld();null===l.parent&&l.updateMatrixWorld();ia.copy(l.matrixWorldInverse.getInverse(l.matrixWorld));G.multiplyMatrices(l.projectionMatrix,ia);V.setFromMatrix(G);S=0;m.objects.length=0;m.lights.length=0;b.traverseVisible(function(a){a instanceof THREE.Light?m.lights.push(a):a instanceof THREE.Mesh||a instanceof THREE.Line?!1!==a.material.visible&&(!0===a.frustumCulled&&!1===V.intersectsObject(a)||L(a)):a instanceof THREE.Sprite&&!1!==a.material.visible&&(!0===a.frustumCulled&&!1===
V.intersectsSprite(a)||L(a))});!0===B&&m.objects.sort(fa);b=0;for(B=m.objects.length;b<B;b++){var e=m.objects[b].object,g=e.geometry;u.setObject(e);D=e.matrixWorld;K=0;if(e instanceof THREE.Mesh)if(g instanceof THREE.BufferGeometry){var k=g.attributes,e=g.groups;if(void 0!==k.position){for(var c=k.position.array,a=0,d=c.length;a<d;a+=3)u.pushVertex(c[a],c[a+1],c[a+2]);if(void 0!==k.normal)for(var J=k.normal.array,a=0,d=J.length;a<d;a+=3)u.pushNormal(J[a],J[a+1],J[a+2]);if(void 0!==k.uv)for(k=k.uv.array,
a=0,d=k.length;a<d;a+=2)u.pushUv(k[a],k[a+1]);if(null!==g.index)if(c=g.index.array,0<e.length)for(b=0;b<e.length;b++)for(d=e[b],a=d.start,d=d.start+d.count;a<d;a+=3)u.pushTriangle(c[a],c[a+1],c[a+2]);else for(a=0,d=c.length;a<d;a+=3)u.pushTriangle(c[a],c[a+1],c[a+2]);else for(a=0,d=c.length/3;a<d;a+=3)u.pushTriangle(a,a+1,a+2)}}else{if(g instanceof THREE.Geometry){var v=g.vertices,a=g.faces,d=g.faceVertexUvs[0];U.getNormalMatrix(D);for(var c=e.material,k=c instanceof THREE.MultiMaterial,J=!0===k?
e.material:null,p=0,y=v.length;p<y;p++){var z=v[p];r.copy(z);if(!0===c.morphTargets)for(var E=g.morphTargets,w=e.morphTargetInfluences,t=0,N=E.length;t<N;t++){var A=w[t];if(0!==A){var O=E[t].vertices[p];r.x+=(O.x-z.x)*A;r.y+=(O.y-z.y)*A;r.z+=(O.z-z.z)*A}}u.pushVertex(r.x,r.y,r.z)}v=0;for(p=a.length;v<p;v++)if(y=a[v],c=!0===k?J.materials[y.materialIndex]:e.material,void 0!==c&&(w=c.side,g=x[y.a],z=x[y.b],E=x[y.c],!1!==u.checkTriangleVisibility(g,z,E))){t=u.checkBackfaceCulling(g,z,E);if(w!==THREE.DoubleSide){if(w===
THREE.FrontSide&&!1===t)continue;if(w===THREE.BackSide&&!0===t)continue}f=X();f.id=e.id;f.v1.copy(g);f.v2.copy(z);f.v3.copy(E);f.normalModel.copy(y.normal);!1!==t||w!==THREE.BackSide&&w!==THREE.DoubleSide||f.normalModel.negate();f.normalModel.applyMatrix3(U).normalize();N=y.vertexNormals;A=0;for(O=Math.min(N.length,3);A<O;A++){var W=f.vertexNormalsModel[A];W.copy(N[A]);!1!==t||w!==THREE.BackSide&&w!==THREE.DoubleSide||W.negate();W.applyMatrix3(U).normalize()}f.vertexNormalsLength=N.length;w=d[v];
if(void 0!==w)for(t=0;3>t;t++)f.uvs[t].copy(w[t]);f.color=y.color;f.material=c;f.z=(g.positionScreen.z+z.positionScreen.z+E.positionScreen.z)/3;f.renderOrder=e.renderOrder;m.elements.push(f)}}}else if(e instanceof THREE.Line)if(g instanceof THREE.BufferGeometry){if(k=g.attributes,void 0!==k.position){c=k.position.array;a=0;for(d=c.length;a<d;a+=3)u.pushVertex(c[a],c[a+1],c[a+2]);if(null!==g.index)for(c=g.index.array,a=0,d=c.length;a<d;a+=2)u.pushLine(c[a],c[a+1]);else for(k=e instanceof THREE.LineSegments?
2:1,a=0,d=c.length/3-1;a<d;a+=k)u.pushLine(a,a+1)}}else{if(g instanceof THREE.Geometry&&(T.multiplyMatrices(G,D),v=e.geometry.vertices,0!==v.length))for(g=F(),g.positionScreen.copy(v[0]).applyMatrix4(T),k=e instanceof THREE.LineSegments?2:1,p=1,y=v.length;p<y;p++)g=F(),g.positionScreen.copy(v[p]).applyMatrix4(T),0<(p+1)%k||(z=x[K-2],H.copy(g.positionScreen),I.copy(z.positionScreen),!0===ka(H,I)&&(H.multiplyScalar(1/H.w),I.multiplyScalar(1/I.w),h=aa(),h.id=e.id,h.v1.positionScreen.copy(H),h.v2.positionScreen.copy(I),
h.z=Math.max(H.z,I.z),h.renderOrder=e.renderOrder,h.material=e.material,e.material.vertexColors===THREE.VertexColors&&(h.vertexColors[0].copy(e.geometry.colors[p]),h.vertexColors[1].copy(e.geometry.colors[p-1])),m.elements.push(h)))}else e instanceof THREE.Sprite&&(n.set(D.elements[12],D.elements[13],D.elements[14],1),n.applyMatrix4(G),a=1/n.w,n.z*=a,-1<=n.z&&1>=n.z&&(q=ja(),q.id=e.id,q.x=n.x*a,q.y=n.y*a,q.z=n.z,q.renderOrder=e.renderOrder,q.object=e,q.rotation=e.rotation,q.scale.x=e.scale.x*Math.abs(q.x-
(n.x+l.projectionMatrix.elements[0])/(n.w+l.projectionMatrix.elements[12])),q.scale.y=e.scale.y*Math.abs(q.y-(n.y+l.projectionMatrix.elements[5])/(n.w+l.projectionMatrix.elements[13])),q.material=e.material,m.elements.push(q)))}!0===M&&m.elements.sort(fa);return m}};
